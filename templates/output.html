{% macro color_plddt(plddt) %}
    <span style="color:
            {% if plddt > 70 %}
                green
            {% elif plddt < 50 %}
                red
            {% else %}
                orange
            {% endif %}
         ">{{ plddt }} average pLDDT</span>
{% endmacro %}


<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">

    <title>ARCIMBOLDO-AIR</title>
        <style type='text/css'>
            body {
                color: #000000;
                background: #FFFFFF;
                font-family: sans-serif;
                padding: 0px !important;
                margin: 0px !important;
                font-size:16px;
            }

            #interface_graphs ul li {
                list-style: none;
            }

            .green-row {
                background-color: #8cbc6c;
            }

            .blue-row {
                background-color: #9ec3e5;
            }

            .green {
                color: green;
            }

            .blue {
                color: blue;
            }

            .hide-row{
            }

            #frobenius_graphs ul li {
                list-style: none;
            }

            #sidebar ul li {
                list-style: none;
            }

            #container-main {
            display: inline-block;
            margin-left: 140px;
            margin-top: 40px;
            max-width: 88%;
            }

            #sidebar {
            width: 120px;
            height: 100%;
            position: fixed;
            background: #31393c;
            }

            #header {
            padding: 0 15px;
            position: fixed;
            left: 0;
            right: 0;
            z-index: 1002;
            background: #2176ff;
            border-bottom: 1px solid #33a1fd;
            color: #FFFFFF;
            text-align: center;
            }

            h1 {
            margin-top: 5px;
            margin-bottom: 5px;
            }

            h2 {
            margin-top: 20px;
            }

            h4 {
            margin-top: 20px;
            margin-bottom: 0px;
            }

            ul.sidebar-menu , ul.sidebar-menu li ul.sub{
            margin: -2px 0 0;
            padding: 0;
            }

            ul.sidebar-menu {
            margin-top: 75px;
            }

            ul.sidebar-menu li ul.sub li{
            background: #31393c;
            margin-bottom: 0;
            margin-left: 0;
            margin-right: 0;
            }

            ul.sidebar-menu li ul.sub li{
            font-size: 14px;
            padding: 6px 0;
            line-height: 35px;
            height: 35px;
            color: #aeb2b7;
            }

            ul.sidebar-menu li ul.sub li:hover {
            color: white;
            background: transparent;
            }

            ul.sidebar-menu li ul.sub li.active{
                color: #68dff0;
                display: block;
            }

            ul.sidebar-menu li{
                color: #FFFFFF;
                text-decoration: none;
                display: block;
                padding: 15px 0 15px 10px;
                font-size: 14px;
                outline: none;
                margin-bottom: 5px;
                margin-left:10px;
                margin-right:10px;
            }

            ul.sidebar-menu li.active, ul.sidebar-menu li:hover, ul.sidebar-menu li:focus {
                background: #767B7D;
                color: #fff;
                display: block;
            }color_plddt

            .section-div{
                padding-top: 35px;
            }
            .btn {
                display: inline-block;
                text-align: center;
                text-decoration: none;
                vertical-align: middle;
                cursor: pointer;
                float: left;
                border: 1px solid #424242;
                background-color: #e7e7e7;
            }
            .btn:hover{
                background-color: #b8b8b8;
            }

            table {
                border-collapse: collapse;
                width: auto;
            }
            th{
                border: 2px solid #000000;
                background-color: #b8b8b8;
                text-align: center;
                padding: 8px;
            }
            li{
                margin: 10px 0;
            }

            td{
                border: 2px solid #000000;
                text-align: center;
                padding: 8px;
            }
            .details-frobenius {
                border: 2px solid #000000;
            }

            .details-frobenius-in {
                padding-left: 10px;
            }

            .details-frobenius ul li{
                padding: 10px;
                margin: 0px;
                border-top: 1px solid black;

            }
            .summary-frobenius {
                padding: 10px;
                background-color: #b8b8b8;
            }
            .div-frobenius {
                padding-left: 15px;
            }
            pre code {
                background-color: #eee;
                border: 1px solid #999;
                display: block;
                padding: 20px;
            }
        </style>
    </head>
    <body id="init_body">
        <header id="header">
            <h1 class="logo">ARCIMBOLDO-AIR</h1>
        </header>
        <aside>
            <div id="sidebar" class="nav-collapse">
                <ul class="sidebar-menu">
                <li name="summary" onclick="move_to(event)" class="sub-menu">Summary</li>
                <li name="input" onclick="move_to(event)" class="sub-menu">Input</li>
                {% if 'gantt' in data %}
                    <li name="alignment" onclick="move_to(event)" class="sub-menu">Alignment</li>
                {% endif %}
                {% if 'plddt' in data %}
                    <li name="plddt" onclick="move_to(event)" class="sub-menu">PLDDT for predictions</li>
                {% endif %}
                {% if 'clustering_plot' in data %}
                    <li name="clustering" onclick="move_to(event)" class="sub-menu">Clustering</li>                
                {% endif %}
                {# note: commented-out template because we no longer use this
                {% if 'frobenius_dict' in data %}
                    <li name="frobenius_graphs" onclick="move_to(event)" class="sub-menu">Frobenius Graphs</li>                
                {% endif %}
                #}
                {# note: commented-out template because we no longer use this
                {% if 'dendogram_struct' in data %}
                    <li name="dendogram" onclick="move_to(event)" class="sub-menu">Dendogram</li>                
                {% endif %}
                #}
                {% if 'interfaces_dict' in data %}
                    <li name="interface_graphs" onclick="move_to(event)" class="sub-menu">Interface Graphs</li>                
                {% endif %}
                {% if 'table' in data %}
                    <li name="tables" onclick="move_to(event)" class="sub-menu">Tables</li>
                {% endif %}
                {% if 'pymol' in data %}
                    <li name="pymol" onclick="move_to(event)" class="sub-menu">Pymol</li>
                {% endif %}
                <li name="log" onclick="move_to(event)" class="sub-menu">Log file</li>
                <li name="conclusions" onclick="move_to(event)" class="sub-menu">Conclusions</li>
                <li name="citations" onclick="move_to(event)" class="sub-menu">Citations</li>
                <li name="support" onclick="move_to(event)" class="sub-menu">Support</li>
                </ul>
            </div>
        </aside>

        <section id="container-main">
            <p style="margin-top:30px">
                VAIRO guides predictions towards particular dynamic states selecting the prior information input or analysing the results of the search.
            </p>            
            <div id="summary" class="section-div">
                <h2>Summary</h2>
                <p>State: {{ data.state }}</p>
                <p></p>
                {% if data.custom_features %}
                    The
                    {% if data.total_copies > 1 %}
                        complex
                    {% else %}
                        structure
                    {% endif %}                    
                    is predicted in homology to {{ data.num_templates }} template/s, {{ data.number_alignments }} alignment/s provided.
                {% else %}
                    AF-selected templates will be analysed and structurally clustered. Predictions will be driven towards the different extreme structures.
                {% endif %}
                {% if data.mosaic > 1%} 
                     {{ data.mosaic }} partially overlapping fragments are predicted and merged into the structure.
                {% endif %}
                </p>
                {% if data.complete_html  %}
                    <p>On this page, only the top 20 most complete and/or similar to the prediction templates are displayed. To access the full list of templates, please click the following <a href="{{data.complete_html}}" target="_blank">link</a> </p>
                {% endif %}
                {% if data.ranked_by_rmsd %}
                    {% for key, values in data.ranked_by_rmsd.items() %}
                        {% if loop.first %}
                            <p>Best result is <span class="green">{{ values[0].name }}</span> with a {{color_plddt(values[0].plddt)}}.
                                {% if data.ranked_list[0].superposition_experimental %}
                                    It has been determined to be the best prediction because it has the best qscore with respect to an experimental pdb ({{ data.ranked_list[0].superposition_experimental[0].pdb }}: {{ data.ranked_list[0].superposition_experimental[0].qscore }}).
                                {% endif %}
                                Can be found in the following path: <a download="{{ values[0].name }}.pdb" href=data:text/plain;base64,{{ values[0].encoded }}>{{ values[0].path }}</a>
                            </p>
                            {% for ranked in values if ranked.name != values[0].name %}
                                {% if loop.first %}
                                    <p>Other equal structural solutions are:</p>
                                    <ul>
                                {% endif %}
                                    <li><span class="green"> {{ ranked.name }}</span>: <a download="{{ ranked.name }}.pdb" href=data:text/plain;base64,{{ ranked.encoded }}> {{ ranked.path }}</a> ({{ ranked.rmsd }} RMSD with {{ values[0].name }})</li>
                                {% if loop.last %}
                                    </ul>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% if loop.index == 2 %}
                                <p>Other successful predictions can be grouped in {{ data.ranked_by_rmsd|length - 1 }} structurally consistent sets:</p>
                                <ul>
                                {% endif %}
                                <li>{{ key }} group:</li>
                                    {% for ranked in values %}
                                        {% if loop.first %}
                                            <ul>
                                                {% if ranked.name in data.filtered_dict %}
                                                    <li><span class="blue"> {{ ranked.name }}</span>: <a download="{{ ranked.name }}.pdb" href=data:text/plain;base64,{{ ranked.encoded }}> {{ ranked.path }}</a> ({{ color_plddt(ranked.plddt) }})</li>
                                                {% else %}
                                                    <li><span> {{ ranked.name }}</span>: <a download="{{ ranked.name }}.pdb" href=data:text/plain;base64,{{ ranked.encoded }}> {{ ranked.path }}</a> ({{ color_plddt(ranked.plddt) }})</li>
                                                {% endif %}
                                        {% else %}
                                                {% if ranked.name in data.filtered_dict %}
                                                    <li><span class="blue"> {{ ranked.name }}</span>: <a download="{{ ranked.name }}.pdb" href=data:text/plain;base64,{{ ranked.encoded }}> {{ ranked.path }}</a> ({{ ranked.rmsd }} RMSD with {{ key }})</li>
                                                {% else %}
                                                    <li><span> {{ ranked.name }}</span>: <a download="{{ ranked.name }}.pdb" href=data:text/plain;base64,{{ ranked.encoded }}> {{ ranked.path }}</a> ({{ ranked.rmsd }} RMSD with {{ key }})</li>
                                                {% endif %}
                                        {% endif %}
                                        {% if loop.last %}
                                            </ul>
                                        {% endif %}
                                    {% endfor %}                                
                            {% if loop.last %}
                                </ul>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if data.info_input %}
                    {% if data.num_msa == 0 %}
                        <p>No sequences have been added to the MSA
                    {% else %}
                        <p>There is/are {{ data.num_msa }} sequence/s in the MSA
                    {% endif %}
                    {% if data.num_templates == 0 %}
                        and no templates have been added to the input.
                    {% else %}
                        and {{ data.num_templates }} template/s has/have been used as input.
                    {% endif %}
                    It can be broken down in the following way:</p>
                    <ul>
                        <li>A copy from the query sequence: 1 sequence.</li>
                        {% for info in data.info_input %}
                            {% if loop.first %} 
                                {% if info.num_templates != 0 or  info.num_msa != 0 %}     
                                    <li> From the user input: {{ info.num_templates }} template/s and {{  info.num_msa }} sequence/s.</li>
                                {% endif %}
                                
                            {% else %}
                                <li> From {{ info.type }} {{ info.path }}: {{ info.num_templates }} template/s and {{  info.num_msa }} sequence/s.</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if data.templates_list %}
                    {% for template in data.templates_list if template.change_res_struct.change_residues_list %}
                            {% if loop.first %}
                                <p>The following changes have been made to the sequence of the templates:</p>
                                    <ul>
                            {% endif %}
                            <li> {{ template.pdb_id }}:
                                <ul>
                        {% for change in template.change_res_struct.change_residues_list %}
                                    <li>
                                        {% if change.when == 'before_alignment'  %}
                                            Before alignment
                                        {% else %}
                                            After alignment
                                            of the templates, sequence has been replaced with
                                        {% endif %}
                                        {% if change.resname is not none  %}
                                            {{ change.resname }}
                                        {% else %}
                                            the query sequence in {{change.fasta_path }}
                                        {% endif %}
                                        in the following residues:
                                        <ul>
                                        {% for key, value in change.chain_group_res_dict.items() %}
                                            <li> Chain {{ key }}: {{ value|join(', ') }}</li>
                                        {% endfor %}
                                        </ul>
                                    </li>
                        {% endfor %}
                        {% if template.change_res_list  %}
                                </ul>
                            </li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                {% endif %}

            </div>
            <div id="input" class="section-div">
                <h2>Input</h2>
                <div style="padding: 10px;height:400px;width:90%;border:1px solid #000;overflow:auto;">
                    <pre>{{ data.bor_text }}</pre>
                </div>
            </div>
            {% if 'gantt' in data %}
                <div id="alignment" class="section-div">
                    <h2>Alignment</h2>
                        <img style="width: 100%" src="data:image/png;base64,{{ data.gantt.plot_both }}" alt="Gantt diagram with msa and templates">
                        <p style="white-space: pre-wrap;">{{ data.gantt.legend_both }}</p>

                        <ul style="margin: 0px 0px; padding-left: 0px">
                            <li style="list-style: none;">
                                <details>
                                <summary><h4 style="display:inline">Templates plot</h4></summary>
                                    <img style="width: 100%" src="data:image/png;base64,{{ data.gantt.plot_template }}" alt="Gantt diagram with templates">
                                    <p style="white-space: pre-wrap;">{{ data.gantt.legend_template }}</p>
                                </details>
                            </li>
                            <li style="list-style: none;">
                            <details>
                            <summary><h4 style="display:inline">MSA plot</h4></summary>
                                    <img style="width: 100%" src="data:image/png;base64,{{ data.gantt.plot_msa }}" alt="Gantt diagram with msa">
                                    <p style="white-space: pre-wrap;">{{ data.gantt.legend_msa }}</p>
                            </details>
                            </li>
                        </ul>
                </div>
            {% endif %}
            {% if 'plddt' in data %}
                <div id="plddt" class="section-div">
                    <h2>pLDDT for predictions</h2>
                    <img style="width: 100%" src="data:image/png;base64,{{ data.plddt }}" alt="PLDDT graph">
                </div>
            {% endif %}
            {% if 'clustering_plot' in data %}
                <div id="clustering" class="section-div">
                    <h2>Clustering</h2>
                    {% if 'cluster_list' in data %}
                        <p>The templates have been divided in {{ data.cluster_list | length }} clusters.
                            {{ data.cluster_list | length }} VAIRO jobs have been launched using the following templates:
                        </p>
                        {% for cluster in data.cluster_list %}
                            {% if loop.first %}
                                <ul>
                            {% endif %}
                                <li><a href=../{{ cluster.relative_path }}>{{ cluster.label }}</a>: {{ cluster.templates | join(', ') }}</li>
                            {% if loop.last %}
                                </ul>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <img style="width: 70%" src="data:image/png;base64,{{ data.clustering_plot }}" alt="Clustering plot">
                    {% if 'clustering_ranked_plot' in data %}
                        <img style="width: 70%" src="data:image/png;base64,{{ data.clustering_ranked_plot }}" alt="Clustering plot and predictions">                  
                    {% endif %}
                </div>
            {% endif %}

            {# note: commented-out template because we no longer use this
            {% if 'frobenius_dict' in data %}
                <div id="frobenius_graphs" class="section-div">
                    <h2>Frobenius Graphs</h2>
                    <div>
                        <span style="vertical-align: middle;">Frobenius distance: </span>
                        <img style="width: 30%; vertical-align: middle;" src="data:image/png;base64,{{ data.frobenius_equation }}" alt="Frobenius distances graph">
                    </div>
                    <div>
                        <span style="vertical-align: middle;">Where: </span>
                        <img style="width: 15%; vertical-align: middle;" src="data:image/png;base64,{{ data.frobenius_equation2 }}" alt="Frobenius distances graph">
                    </div>
                    <br>
                    {% for key, value in data.frobenius_dict.items() %}
                        <details class="details-frobenius"
                        {% if key == data.ranked_list[0].name %}
                         open
                        {% endif %}
                        >
                        <summary class="summary-frobenius"> <h3 style="display:inline">{{ key }}</h3></summary>
                        {% for ranked in value %}
                                {% if loop.first %}
                                    <ul style="margin: 0px 0px; padding-left: 0px">
                                {% endif %}
                                    <li>
                                            {% if loop.index == 2 %}
                                                <details class="details-frobenius-in">
                                                <summary><h4 style="display:inline">{{ ranked.template }}: Worst coverage ({{ ranked.core }} CV)</h4></summary>
                                            {% elif loop.first %}
                                                <details class="details-frobenius-in" open>
                                                <summary><h4 style="display:inline">{{ ranked.template }}: Best coverage ({{ ranked.core }} CV)</h4></summary>
                                            {% else %}
                                                <details class="details-frobenius-in">
                                                <summary><h4 style="display:inline">{{ ranked.template }} ({{ ranked.core }} CV)</h4></summary>
                                            {% endif %}
                                            <div class="div-frobenius">
                                                <p>Frobenius distance of CV distances: {{ ranked.dist_coverage }}</p>
                                                <p>Frobenius distance of CV angles: {{ ranked.ang_coverage }}</p>
                                                <div style="display:flex;">
                                                    <div style="float:left;">
                                                        <p>Between distances</p>
                                                        <img style="width: 80%" src="data:image/png;base64,{{ ranked.encoded_dist_plot  }}" alt="Frobenius distances graph">
                                                    </div>
                                                    <div style="float:left;">
                                                        <p>Between angles</p>
                                                        <img style="width: 80%" src="data:image/png;base64,{{ ranked.encoded_ang_plot  }}" alt="Frobenius angles graph">
                                                    </div>
                                                </div>
                                                {% if data.sequence_plot  %}
                                                    <img style="width: 80%" src="data:image/png;base64,{{ data.sequence_plot  }}" alt="Sequence plot">
                                                {% endif %}
                                                </div>
                                        </details>
                                    </li>
                                {% if loop.last %}
                                    </ul>
                                {% endif %}
                        {% endfor %}
                        </details>
                    {% endfor %}
                </div>
            {% endif %}
            #}
            {# note: commented-out template because we no longer use this
            {% if 'dendogram_struct' in data %}
                <div id="dendogram" class="section-div">
                    <h2>Dendogram</h2>
                    {% if data.dendogram_struct.dendogram_list %}
                        <p>The templates have been divided in {{ data.dendogram_struct.dendogram_list | length }} clusters.</p>
                        {% for cluster in data.dendogram_struct.dendogram_list %}
                            {% if loop.first %}
                                <ul>
                            {% endif %}
                                <li>{{ cluster | join(', ') }}</li>
                            {% if loop.last %}
                                </ul>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    <img style="width: 70%" src="data:image/png;base64,{{ data.dendogram_struct.encoded_dendogram_plot }}" alt="Dendogram plot">
                </div>  
            {% endif %}
            #}
            {% if 'interfaces_dict' in data %}
                <div id="interface_graphs" class="section-div">
                    <h2>Interface Graphs</h2>
                    {% for key, interfaces in data.interfaces_dict.items() %}
                            {% for interface in interfaces %}
                                {% if loop.first %}
                                <details class="details-frobenius"
                                {% if key == data.ranked_list[0].name %}
                                 open
                                {% endif %}
                                >
                                    <summary class="summary-frobenius"> <h3 style="display:inline">{{ key }}</h3></summary>
                                    <ul style="margin: 0px 0px; padding-left: 0px">
                                {% endif %}
                                    {% for template in interface.interface_template if template.core > 0 %}
                                    {% if loop.first %}
                                        <li>
                                            <details class="details-frobenius-in">
                                                <summary><h4 style="display:inline">{{ interface.name }}</h4></summary>
                                                <p> Solvation for each chain:
                                                    <ul>
                                                        <li style="border: none; list-style: disc;">{{ interface.chain1 }}: Solvation: {{ interface.solvation1 }}, SE gain: {{ interface.se_gain1 }}</li>
                                                        <li style="border: none; list-style: disc;">{{ interface.chain2 }}: Solvation: {{ interface.solvation2 }}, SE gain: {{ interface.se_gain2 }}</li>
                                                    </ul>
                                                </p>
                                                <p>The interface can be found in the following templates:</p>
                                                <ul style="padding-left: 5px;">
                                    {% endif %}
                                                    <li style="border-top: 0px">
                                                        <details class="details-frobenius-in">
                                                            <summary><h4 style="display:inline">{{ template.template }}</h4></summary>
                                                            <div class="div-frobenius">
                                                                <p>Distance Frobenius is: {{ template.dist_coverage }}</p>
                                                                <p>Core is: {{ template.core }} CV</p>
                                                                <img style="width: 40%" src="data:image/png;base64,{{ template.encoded_dist_plot  }}" alt="Interface distances graph">
                                                                {% if data.sequence_plot  %}
                                                                    <img style="width: 80%" src="data:image/png;base64,{{ data.sequence_plot  }}" alt="Sequence plot">
                                                                {% endif %}
                                                            </div>
                                                        </details>
                                                    </li> 
                                        {% if loop.last %}
                                                </ul>
                                                </details>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                {% if loop.last %}
                                    </ul>
                                    </details>

                                {% endif %}
                            {% endfor %}
                    {% endfor %}
                </div>
            {% endif %}
            {% if 'table' in data %}
            <div id="tables" class="section-div">
                <h2>Tables</h2>
                {% if data.ranked_list %}
                    <h3>pLDDT information</h3>
                    <table id="table_average_plddt">
                        <tr>
                            <th>Predictions</th>
                            <th>Average pLDDT</th>
                            <th>Compactness</th>
                            <th>Percentage Ramachandran outliers</th>
                        </tr>
                        {% for ranked in data.ranked_list %}
                            {% if ranked.name in data.bests_dict %}
                                <tr class="green-row">
                            {% elif ranked.name in data.filtered_dict %}
                                <tr class="blue-row">
                            {% else %}
                                <tr class="hide-row" style="display:none;">
                            {% endif %}
                                <td>{{ ranked.name }}</td>
                                <td>{{ ranked.plddt }}</td>
                                <td>{{ ranked.compactness }}</td>
                                <td>{{ ranked.ramachandran }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                    <button onclick="hideValues('table_average_plddt', this)">Show all predictions</button>
                {% endif %}
                {% if 'secondary_dict' in data.table %}
                    <h3>Secondary structure percentages calculated with ALEPH</h3>
                    <table id="table_ss">
                        <tr>
                            <th>Prediction</th>
                            <th>Helix</th>
                            <th>Beta</th>
                        </tr>
                        {% for key, value in data.table.secondary_dict.items() %}
                            {% if key in data.bests_dict %}
                                <tr class="green-row">
                            {% elif key in data.filtered_dict %}
                                <tr class="blue-row">
                            {% else %}
                                <tr class="hide-row" style="display:none;">
                            {% endif %}
                                <td>{{ key }}</td>
                                <td>{{ value.ah }}</td>
                                <td>{{ value.bs }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                    <button onclick="hideValues('table_ss', this)">Show all predictions</button>
                {% endif %}
                {% if 'energies_dict' in data.table %}
                    <h3>Prediction energies</h3>
                    <table id="table_energies">
                        <tr>
                            <th>Prediction</th>
                            <th>potential (kcal/mol)</th>
                        </tr>
                        {% for key, value in data.table.energies_dict.items() %}
                            {% if key in data.bests_dict %}
                                <tr class="green-row">
                            {% elif key in data.filtered_dict %}
                                <tr class="blue-row">
                            {% else %}
                                <tr class="hide-row" style="display:none;">
                            {% endif %}
                                <td>{{ key }}</td>
                                <td>{{ value }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                    <button onclick="hideValues('table_energies', this)">Show all predictions</button>
                {% endif %}
                {% if 'ranked_rmsd_dict' in data.table %}
                    <h3>Superposition between predictions (RMSD)</h3>
                    <table id="table_rankeds_rmsd">
                        <tr>
                            <th>Prediction</th>
                            {% for key in data.table.ranked_rmsd_dict.keys() %}
                                <th>{{ key }}</th>
                            {% endfor %}
                        </tr>
                        {% for key, value in data.table.ranked_rmsd_dict.items() %}
                            {% if key in data.bests_dict %}
                                <tr class="green-row">
                            {% elif key in data.filtered_dict %}
                                <tr class="blue-row">
                            {% else %}
                            <tr class="hide-row" style="display:none;">
                            {% endif %}
                                <td>{{ key }}</td>
                                {% for value2 in value.values() %}
                                    <td>{{ value2 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </table>
                    <button onclick="hideValues('table_rankeds_rmsd', this)">Show all predictions</button>
                {% endif %}
                {% if 'rmsd_dict' in data.table %}
                    <h3>Superposition of predictions and templates (RMSD, superposed residues, total residues)</h3>
                    <table id="table_templates_rmsd">
                        <tr>
                            <th>Prediction</th>
                            {% for value in data.table.rmsd_dict.values() %}
                                {% for key in value.keys() if loop.first%}            
                                    <th>{{ key }}</th>
                                {% endfor %}
                            {% endfor %}
                        </tr>
                        {% for key, value in data.table.rmsd_dict.items() %}
                            {% if key in data.bests_dict %}
                                <tr class="green-row">
                            {% elif key in data.filtered_dict %}
                                <tr class="blue-row">
                            {% else %}
                            <tr class="hide-row" style="display:none;">
                            {% endif %}
                                <td>{{ key }}</td>
                                {% for key2, value2 in value.items() %}
                                    <td>{{ value2.rmsd }} ({{ value2.aligned_residues }} of {{ value2.total_residues }})</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </table>
                    <button onclick="hideValues('table_templates_rmsd', this)">Show all predictions</button>
                {% endif %}
                {% if 'experimental_dict' in data.table %}
                    <h3>Superposition of experimental pdbs with predictions and templates (RMSD (superposed residues), Q-Score)</h3>

                    <table>
                        <tr>
                            <th>experimental pdb</th>
                            {% for value in data.table.experimental_dict.values() %}
                                {% for key in value.keys() if loop.first%}
                                    <th>{{ key }}</th>
                                {% endfor %}
                            {% endfor %}
                        </tr>
                        {% for key, value in data.table.experimental_dict.items() %}
                            <tr>
                                <td>{{ key }}</td>
                                {% for value2 in value.values() %}
                                    {% if key2 in data.bests_dict %}
                                        <td class="blue-row">{{ value2.rmsd }} ({{ value2.aligned_residues }} of {{ value2.total_residues }}), {{ value2.qscore }}</td>
                                    {% elif key in data.filtered_dict %}
                                        <td class="blue-row">{{ value2.rmsd }} ({{ value2.aligned_residues }} of {{ value2.total_residues }}), {{ value2.qscore }}</td>                                
                                    {% else %}
                                        <td>{{ value2.rmsd }} ({{ value2.aligned_residues }} of {{ value2.total_residues }}), {{ value2.qscore }}</td>
                                    {% endif %} 
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </table>
                {% endif %}
            </div>
            {% endif %}
            {% if 'pymol' in data %}
                <div id="pymol" class="section-div">
                    <h2>Pymol</h2>
                    <p>In order to run the Pymol Script, run the following code in the terminal:</p>
                    <pre>
                        <code>pymol {{ data.pymol }} </code>
                    </pre>
                </div>
            {% endif %} 
            <div id="log" class="section-div">
                <h2>Log</h2>
                <div style="padding: 10px;height:400px;width:90%;border:1px solid #000;overflow:auto;">
                    <pre>{{ data.log_text }}</pre>
                </div>
            </div>  
            <div id="conclusions" class="section-div">
                <h2>Conclusions</h2>
                {% if data.bests_dict|length == 1 %}
                    <p>The best predicted model is <span class="green">{{ data.ranked_list[0].name }}</span>.
                        {% if data.ranked_list[0].superposition_experimental %}
                            The closest experimental is {{ data.ranked_list[0].superposition_experimental[0].pdb }} with a {{ data.ranked_list[0].superposition_experimental[0].rmsd }} RMSD</p>
                        {% endif %}
                        {% if data.ranked_list[0].superposition_templates %}
                            The closest template is {{ data.ranked_list[0].superposition_templates[0].pdb }} with a {{ data.ranked_list[0].superposition_templates[0].rmsd }} RMSD</p>
                        {% endif %}
                {% elif data.bests_dict|length > 1 %}
                    <p>There are {{ data.bests_dict|length }} equal best predicted models:
                        {% for key, value in data.bests_dict.items() %}
                            <span class="green">{{ key }}</span>
                            {% if not loop.last %}
                                ,
                            {% endif %}
                        {% endfor %}
                    </p>
                {% else %}
                    <p>Predictions could not be found.</p>
                {% endif %}
                {% if data.conclusion_dict %}
                    <p>The closest {{ data.conclusion_type }} to the predictions are the following ones:</p>
                        <ul>
                            {% for key, value in data.conclusion_dict.items() %}
                                <li>{{ key }}:
                                    {% for ranked in value %}
                                        {% if ranked in data.bests_dict %}
                                            <span class="green">{{ ranked }}</span>
                                        {% elif ranked in data.filtered_dict %}
                                            <span class="blue">{{ ranked }}</span>
                                        {% else %}
                                            {{ ranked }}
                                        {% endif %}
                                        {% if not loop.last %}
                                            ,
                                        {% endif %}
                                    {% endfor %}
                                </li>
                            {% endfor %}
                        </ul>

                    {% if data.template_interfaces and data.conclusion_type  == 'template' %}
                        {% for key, value in data.template_interfaces.items() if value %}
                        {% if loop.first %}
                            <p>Each template has the following interfaces:</p>
                            <ul>
                        {% endif %}
                                <li>{{ key }}:
                                    {% for interface in value %}
                                        {% if loop.first %}
                                            <ul>
                                        {% endif %}
                                            <li>{{ interface }}
                                                {% set interfaces_list = [] %}
                                                {% if 'interfaces_dict' in data %}
                                                    {% for ranked, interfaces in data.interfaces_dict.items() %}
                                                        {% for interface2 in interfaces if interface2.name == interface %}
                                                            {% for interfaces_template in interface2.interface_template if interfaces_template.template == key and interfaces_template.core == 0 %}
                                                                {{ interfaces_list.append(ranked) or "" }}
                                                            {% endfor %}
                                                        {% endfor %}
                                                    {% endfor %}
                                                {%endif %}
                                                {% if interfaces_list %}
                                                    {% for not_interface in interfaces_list %}
                                                        {% if loop.first %}
                                                            : Missing in
                                                        {% endif %}
                                                        {% if not_interface in data.bests_dict %}
                                                            <span class="green">{{ not_interface }}</span>
                                                        {% elif not_interface in data.filtered_dict %}
                                                            <span class="blue">{{ not_interface }}</span>
                                                        {% else %}
                                                            {{ not_interface }}
                                                        {% endif %}
                                                        {% if not loop.last %}
                                                            ,
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </li>
                                        {% if loop.last %}
                                            </ul>
                                        {% endif %}
                                    {% endfor %}
                                </li>
                        {% if loop.last %}
                            </ul>
                            <p> The analysis has only been performed with those predictions that have a high pLDDT average.</p>
                        {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>
            <div id="citations" class="section-div">
                <h2>Citations</h2>
                <p>
                    <a href="https://doi.org/10.1038/s41586-021-03819-2">Highly accurate protein structure prediction with AlphaFold.</a><br>
                    Jumper, J., Evans, R., Pritzel, A.<br>
                    (2021) Nature 596, 583-589.
                </p>
            </div>        
            <div id="support" class="section-div">
                <h2>Support</h2>
                <p>
                For online documentation and tutorials visit <a href="http://chango.ibmb.csic.es">www.chango.ibmb.csic.es</a><br/>
                For developer support send an email to <a href="mailto:bugs-borges@ibmb.csic.es">bugs-borges@ibmb.csic.es</a><br/> 
                Crystallographic Methods Group <br/> 
                <a href="http://www.ibmb.csic.es/">Molecular Biology Institute of Barcelona </a></p>
            </div>
        </section>
    </body>
    <script>
        function move_to(e){
            window.location.hash = e.target.getAttribute("name");
        }

        function hideValues(tableId, button) {
            var table = document.getElementById(tableId, this);
            var elements = table.getElementsByClassName("hide-row");
            for (var i = 0; i < elements.length; i++) {
                var element = elements[i];
                element.style.display = element.style.display === "none" ? "" : "none";
            }
            console.log(button.textContent)
            button.textContent = button.textContent === "Show all predictions"? "Hide bad predictions" : "Show all predictions";
        }

    </script>
</html>
